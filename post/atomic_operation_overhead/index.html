<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.29" />

  <title>Atomic operation overhead &middot; External Storage</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.2/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.2/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.2/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  

  

  <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  

  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/tags/"><i class='fa fa-tags fa-fw'></i>Tags</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/ordovicia" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/ordovicia" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2017. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Atomic operation overhead</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>26 Dec 2016</time>
  </div>

  

  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="/tags/programming">Programming</a>
    
  </div>
  
  

</div>

  <p>ARMはconsistencyが弱く設計されてるメモリモデルだから、強いメモリモデルのx86_64と比べて
atomic変数の操作にともなうオーバーヘッドは大きめ、という記述
<a href="http://yohhoy.hatenablog.jp/entry/2014/12/21/171035">[1]</a><a href="http://www.cl.cam.ac.uk/~pes20/cpp/cpp0xmappings.html">[2]</a>を読んだので、自分でも調べてみました。</p>

<p>CPUではキャッシュ機構やOoOのはたらきにより、
メモリアクセスが機械語の順番通りにおこなわれるとは限りません。
これを制御するために、load/store命令の順序入れ替えに関する振る舞いを定めたものが、
ハードウェアのメモリモデルです。</p>

<p>メモリアクセス順序に保証をもたせたいときは、そのための機構を使用することになります。
それが、順序付けされたload/store命令や、
命令の入れ替えを抑制するメモリバリア命令（またはメモリフェンス命令）です。</p>

<p>x86のメモリバリア命令は<code>mfence</code>で、ARMは<code>dmb</code>となっています。
これらはともに、それより先に発行されたload/store命令は、
後に発行される命令より先に完了していることを保証します。
<a href="http://x86.renejeschke.de/html/file_module_x86_id_170.html">[x86リファレンス]</a>,
<a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0204ij/CIHJFGFE.html">[ARMリファレンス]</a></p>

<p>x86_64とARMのメモリモデルは次のようになっているようです。
<a href="http://yohhoy.hatenablog.jp/entry/2014/12/21/171035">[引用元]</a></p>

<blockquote>
<dl>
<dt> Intel x86(IA-32, x86-64) </dt>
<dd> 逐次一貫性にかなり近いハードウェア・メモリ一貫性モデルのため、追加のオーバーヘッドはほとんどありません。atomic変数への書き出し処理だけが若干のペナルティを受けます(lock xchg命令)。 </dd>

<dt> ARM(ARMv7, ARMv8) </dt>
<dd> 弱いメモリモデルのハードウェア・メモリ一貫性モデルのため、逐次一貫性の実現にはメモリバリア命令発行が必要です(dmb命令)。ARMv8では専用のメモリ・ストア／ロード命令が追加され(stlr/ldar命令)、メモリバリア命令発行が不要になります。 </dd>
</dl>
</blockquote>

<p>ただ、x86で順序付けされたstoreには<code>xchg</code>の代わりに
<code>mov</code>と<code>mfence</code>が使われることもあるそうです
<a href="http://www.cl.cam.ac.uk/~pes20/cpp/cpp0xmappings.html">[参考]</a>。</p>

<p>atomic変数の操作で実際にどんな命令が発行されるか調べるため、次のプログラムをそれぞれ、
<code>Darwin Kernel Version 15.6.0: Wed Nov  2 20:30:56 PDT 2016; root:xnu-3248.60.11.1.2~2/RELEASE_X86_64 x86_64 i386</code>上の、</p>

<ul>
<li>g++ 6.3.0で、オプションは<code>-std=gnu++14 -O3 -S</code></li>
<li>ARM v7用クロスコンパイラarm-none-eabi-g++ 5.4.1で、<code>-mcpu=cortex-m4 -mabi=aapcs -mthumb -std=gnu++14 -O3 -S</code></li>
</ul>

<p>でコンパイルしました。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// atomic.cpp
</span><span style="color:#75715e"></span><span style="">
</span><span style=""></span><span style="color:#75715e">#include</span><span style=""> </span><span style="color:#75715e">&lt;atomic&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="">
</span><span style=""></span><span style="">std</span><span style="color:#f92672">::</span><span style="">atomic</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span><span style=""> </span><span style="">i</span><span style="">{</span><span style="color:#ae81ff">1</span><span style="">};</span><span style="">
</span><span style="">
</span><span style=""></span><span style="color:#66d9ef">void</span><span style=""> </span><span style="color:#a6e22e">f</span><span style="">()</span><span style="">
</span><span style=""></span><span style="">{</span><span style="">
</span><span style="">    </span><span style="color:#66d9ef">int</span><span style=""> </span><span style="">j</span><span style=""> </span><span style="color:#f92672">=</span><span style=""> </span><span style="">i</span><span style="">.</span><span style="">load</span><span style="">();</span><span style="">
</span><span style="">    </span><span style="">i</span><span style="">.</span><span style="">store</span><span style="">(</span><span style="">j</span><span style=""> </span><span style="color:#f92672">*</span><span style=""> </span><span style="color:#ae81ff">2</span><span style="">);</span><span style="">
</span><span style=""></span><span style="">}</span></code></pre>
</div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// nonatomic.cpp
</span><span style="color:#75715e"></span><span style="">
</span><span style=""></span><span style="color:#66d9ef">int</span><span style=""> </span><span style="">i</span><span style=""> </span><span style="color:#f92672">=</span><span style=""> </span><span style="color:#ae81ff">1</span><span style="">;</span><span style="">
</span><span style="">
</span><span style=""></span><span style="color:#66d9ef">void</span><span style=""> </span><span style="color:#a6e22e">f</span><span style="">()</span><span style="">
</span><span style=""></span><span style="">{</span><span style="">
</span><span style="">    </span><span style="color:#66d9ef">int</span><span style=""> </span><span style="">j</span><span style=""> </span><span style="color:#f92672">=</span><span style=""> </span><span style="">i</span><span style="">;</span><span style="">
</span><span style="">    </span><span style="">i</span><span style=""> </span><span style="color:#f92672">=</span><span style=""> </span><span style="">j</span><span style=""> </span><span style="color:#f92672">*</span><span style=""> </span><span style="color:#ae81ff">2</span><span style="">;</span><span style="">
</span><span style=""></span><span style="">}</span></code></pre>
</div>
<p>結果が以下になりました。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#75715e"># x86_64_atomic.s
</span><span style="color:#75715e"></span><span style="">
</span><span style=""></span><span style="">__Z1fv:</span><span style="">
</span><span style=""></span><span style="">LFB325:</span><span style="">
</span><span style="">	</span><span style="color:#a6e22e">movl</span><span style="">	</span><span style="color:#66d9ef">_i</span><span style="">(</span><span style="">%rip</span><span style="">),</span><span style=""> </span><span style="">%eax</span><span style="">
</span><span style="">	</span><span style="color:#a6e22e">addl</span><span style="">	</span><span style="">%eax</span><span style="">,</span><span style=""> </span><span style="">%eax</span><span style="">
</span><span style="">	</span><span style="color:#a6e22e">movl</span><span style="">	</span><span style="">%eax</span><span style="">,</span><span style=""> </span><span style="color:#66d9ef">_i</span><span style="">(</span><span style="">%rip</span><span style="">)</span><span style="">
</span><span style="">	</span><span style="color:#a6e22e">mfence</span><span style="">
</span><span style="">	</span><span style="color:#a6e22e">ret</span></code></pre>
</div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#75715e"># x86_64_nonatomic.s
</span><span style="color:#75715e"></span><span style="">
</span><span style=""></span><span style="">__Z1fv:</span><span style="">
</span><span style=""></span><span style="">LFB0:</span><span style="">
</span><span style="">	</span><span style="color:#a6e22e">sall</span><span style="">	</span><span style="color:#66d9ef">_i</span><span style="">(</span><span style="">%rip</span><span style="">)</span><span style="">
</span><span style="">	</span><span style="color:#a6e22e">ret</span></code></pre>
</div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#75715e"># arm_atomic.s
</span><span style="color:#75715e"></span><span style="">
</span><span style=""></span><span style="">_Z1fv:</span><span style="">
</span><span style="">	</span><span style="color:#a6e22e">.fnstart</span><span style="">
</span><span style=""></span><span style="">.LFB328:</span><span style="">
</span><span style="">	</span><span style="color:#960050;background-color:#1e0010">@</span><span style=""> </span><span style="color:#a6e22e">args</span><span style=""> </span><span style="color:#960050;background-color:#1e0010">=</span><span style=""> </span><span style="color:#ae81ff">0</span><span style="">,</span><span style=""> </span><span style="color:#66d9ef">pretend</span><span style=""> </span><span style="color:#960050;background-color:#1e0010">=</span><span style=""> </span><span style="color:#ae81ff">0</span><span style="">,</span><span style=""> </span><span style="color:#66d9ef">frame</span><span style=""> </span><span style="color:#960050;background-color:#1e0010">=</span><span style=""> </span><span style="color:#ae81ff">0</span><span style="">
</span><span style="">	</span><span style="color:#960050;background-color:#1e0010">@</span><span style=""> </span><span style="color:#a6e22e">frame_needed</span><span style=""> </span><span style="color:#960050;background-color:#1e0010">=</span><span style=""> </span><span style="color:#ae81ff">0</span><span style="">,</span><span style=""> </span><span style="color:#66d9ef">uses_anonymous_args</span><span style=""> </span><span style="color:#960050;background-color:#1e0010">=</span><span style=""> </span><span style="color:#ae81ff">0</span><span style="">
</span><span style="">	</span><span style="color:#960050;background-color:#1e0010">@</span><span style=""> </span><span style="color:#a6e22e">link</span><span style=""> </span><span style="color:#66d9ef">register</span><span style=""> </span><span style="color:#66d9ef">save</span><span style=""> </span><span style="color:#66d9ef">eliminated.</span><span style="">
</span><span style="">	</span><span style="color:#a6e22e">ldr</span><span style="">	</span><span style="color:#66d9ef">r2</span><span style="">,</span><span style=""> </span><span style="color:#66d9ef">.L2</span><span style="">
</span><span style="">	</span><span style="color:#a6e22e">dmb</span><span style="">	</span><span style="color:#66d9ef">sy</span><span style="">
</span><span style="">	</span><span style="color:#a6e22e">ldr</span><span style="">	</span><span style="color:#66d9ef">r3</span><span style="">,</span><span style=""> </span><span style="">[</span><span style="color:#66d9ef">r2</span><span style="">]</span><span style="">
</span><span style="">	</span><span style="color:#a6e22e">dmb</span><span style="">	</span><span style="color:#66d9ef">sy</span><span style="">
</span><span style="">	</span><span style="color:#a6e22e">lsls</span><span style="">	</span><span style="color:#66d9ef">r3</span><span style="">,</span><span style=""> </span><span style="color:#66d9ef">r3</span><span style="">,</span><span style=""> </span><span style="color:#75715e">#1
</span><span style="color:#75715e"></span><span style="">	</span><span style="color:#66d9ef">dmb</span><span style="">	</span><span style="color:#66d9ef">sy</span><span style="">
</span><span style="">	</span><span style="color:#a6e22e">str</span><span style="">	</span><span style="color:#66d9ef">r3</span><span style="">,</span><span style=""> </span><span style="">[</span><span style="color:#66d9ef">r2</span><span style="">]</span><span style="">
</span><span style="">	</span><span style="color:#a6e22e">dmb</span><span style="">	</span><span style="color:#66d9ef">sy</span><span style="">
</span><span style="">	</span><span style="color:#a6e22e">bx</span><span style="">	</span><span style="color:#66d9ef">lr</span></code></pre>
</div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#75715e"># arm_nonatomic.s
</span><span style="color:#75715e"></span><span style="">
</span><span style=""></span><span style="">_Z1fv:</span><span style="">
</span><span style="">	</span><span style="color:#a6e22e">.fnstart</span><span style="">
</span><span style=""></span><span style="">.LFB0:</span><span style="">
</span><span style="">	</span><span style="color:#960050;background-color:#1e0010">@</span><span style=""> </span><span style="color:#a6e22e">args</span><span style=""> </span><span style="color:#960050;background-color:#1e0010">=</span><span style=""> </span><span style="color:#ae81ff">0</span><span style="">,</span><span style=""> </span><span style="color:#66d9ef">pretend</span><span style=""> </span><span style="color:#960050;background-color:#1e0010">=</span><span style=""> </span><span style="color:#ae81ff">0</span><span style="">,</span><span style=""> </span><span style="color:#66d9ef">frame</span><span style=""> </span><span style="color:#960050;background-color:#1e0010">=</span><span style=""> </span><span style="color:#ae81ff">0</span><span style="">
</span><span style="">	</span><span style="color:#960050;background-color:#1e0010">@</span><span style=""> </span><span style="color:#a6e22e">frame_needed</span><span style=""> </span><span style="color:#960050;background-color:#1e0010">=</span><span style=""> </span><span style="color:#ae81ff">0</span><span style="">,</span><span style=""> </span><span style="color:#66d9ef">uses_anonymous_args</span><span style=""> </span><span style="color:#960050;background-color:#1e0010">=</span><span style=""> </span><span style="color:#ae81ff">0</span><span style="">
</span><span style="">	</span><span style="color:#960050;background-color:#1e0010">@</span><span style=""> </span><span style="color:#a6e22e">link</span><span style=""> </span><span style="color:#66d9ef">register</span><span style=""> </span><span style="color:#66d9ef">save</span><span style=""> </span><span style="color:#66d9ef">eliminated.</span><span style="">
</span><span style="">	</span><span style="color:#a6e22e">ldr</span><span style="">	</span><span style="color:#66d9ef">r2</span><span style="">,</span><span style=""> </span><span style="color:#66d9ef">.L2</span><span style="">
</span><span style="">	</span><span style="color:#a6e22e">ldr</span><span style="">	</span><span style="color:#66d9ef">r3</span><span style="">,</span><span style=""> </span><span style="">[</span><span style="color:#66d9ef">r2</span><span style="">]</span><span style="">
</span><span style="">	</span><span style="color:#a6e22e">lsls</span><span style="">	</span><span style="color:#66d9ef">r3</span><span style="">,</span><span style=""> </span><span style="color:#66d9ef">r3</span><span style="">,</span><span style=""> </span><span style="color:#75715e">#1
</span><span style="color:#75715e"></span><span style="">	</span><span style="color:#66d9ef">str</span><span style="">	</span><span style="color:#66d9ef">r3</span><span style="">,</span><span style=""> </span><span style="">[</span><span style="color:#66d9ef">r2</span><span style="">]</span><span style="">
</span><span style="">	</span><span style="color:#a6e22e">bx</span><span style="">	</span><span style="color:#66d9ef">lr</span></code></pre>
</div>
<p>x86の非atomic版は<code>i</code>を二倍するだけに最適化されてしまいましたね。</p>

<p>最適化無しで計算すると、</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#a6e22e">movl</span><span style="">	</span><span style="color:#66d9ef">_i</span><span style="">(</span><span style="">%rip</span><span style="">),</span><span style=""> </span><span style="">%eax</span><span style="">
</span><span style=""></span><span style="color:#a6e22e">addl</span><span style="">	</span><span style="">%eax</span><span style="">,</span><span style=""> </span><span style="">%eax</span><span style="">
</span><span style=""></span><span style="color:#a6e22e">movl</span><span style="">	</span><span style="">%eax</span><span style="">,</span><span style=""> </span><span style="color:#66d9ef">_i</span><span style="">(</span><span style="">%rip</span><span style="">)</span></code></pre>
</div>
<p>になるのでしょう。この最後に<code>mfence</code>命令を挿入したのが、x86のatomic版の結果です。
<code>xchg</code>ではなくてメモリバリア命令が使われてしまいましたが、
一行目での、atomic変数の読み込み後にメモリバリアが発行されないことから、
一行目から三行目までのあいだにメモリの入れ替えが起こらないことがわかり、
x86が強いメモリモデルであることを示しています。</p>

<p>ARM v7版をみてみましょう。
非atomic版は、グローバル変数を読み込んで二倍して書き込んで&hellip;という操作を
アセンブリに忠実に再現しています。
atomic版は、load/storeの前後にいちいちメモリバリアが入っていて、
いかにもオーバーヘッドが大きそうです。
<!--
ちなみに`sy`はシステム全体のバリアという意味です。
storeのみを待つモードもあるので、load前にはこっちを使ったほうがいいんじゃないかな...。
--></p>

<p>上のプログラムでは、<code>std::atomic&lt;T&gt;::store(), load()</code>に指定するメモリオーダーはデフォルト値（最も強く遅い<code>memory_order_seq_cst</code>）を使っています。
適切なメモリオーダーを指定してやればオーバーヘッドは必要最低限まで減らせるはずですが、適切に設定するのは難しそうです。</p>

<p>というわけで、命令数から見るとARM v7はx86とくらべてatomic変数アクセスのオーバーヘッドが大きい
というのは本当らしいことがわかりました。
&lt;!&ndash;</p>

<p>実際の計算時間はどうでしょうか。</p>

<p>以下のプログラムで実行時間を測ってみました。</p>

<script src="https://gist.github.com/ordovicia/152afd43579bdd4888858ebfa157c470.js"></script>

<p>実行環境は以下の通りです。</p>

<ul>
<li><code>macOS Yosemite (Darwin Kernel Version 15.6.0: Tue Apr 11 16:00:51 PDT 2017; root:xnu-3248.60.11.5.3~1/RELEASE_X86_64)</code>で <code>g++ 7.1.0</code> を使い<code>-O3</code>でコンパイル</li>
<li><code>Ubuntu 16.04</code> で <code>g++ 5.4.0</code> を使い<code>-O3</code> でコンパイル</li>
<li><code>Jetson TX1 (Linux tegra-ubuntu 3.10.96-tegra #1 SMP PREEMPT Wed Sep 28 17:51:08 PDT 2016 aarch64 aarch64 aarch64 GNU/Linux)</code> で <code>jetson_clocks.sh</code> を実行後、<code>g++ 5.4.0</code> を使い<code>-O3</code>でコンパイル</li>
</ul>

<p>結果は次のようになりました。
ループ回数を横軸に、非atomicとatomicの比率を縦軸にとっています。</p>

<p><img src="/img/atomic_operation_overhead_benchmark.png" alt="" /></p>

<p>（追記予定）
&ndash;&gt;</p>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="/post/learningrust/lifetime/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="/post/learningrust/lifetime/">Learning Rust - Lifetime</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="/post/well_founded_induction/">Well-founded ordered set</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="/post/well_founded_induction/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  

</div>


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] }
  });
</script>
<script
    type="text/javascript"
    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" />
</script>

