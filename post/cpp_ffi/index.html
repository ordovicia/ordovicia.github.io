<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.24.1" />

  <title>C&#43;&#43; FFI &middot; TIL</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.2/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.2/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.2/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  

  

  <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  

  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/tags/"><i class='fa fa-tags fa-fw'></i>Tags</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/ordovicia" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/ordovicia" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2017. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>C&#43;&#43; FFI</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>25 Jun 2017</time>
  </div>

  

  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="/tags/programming">Programming</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="/tags/c&#43;&#43;">C&#43;&#43;</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="/tags/rust">Rust</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="/tags/python">Python</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="/tags/javascript">Javascript</a>
    
  </div>
  
  

</div>

  

<p>C++と他の言語を結ぶFFIについて少し調べました。
コードは <a href="https://github.com/ordovicia/cplusplus-ffi.git">GitHub</a> にあります。</p>

<h2 id="call-c-from-python">Call C++ from Python</h2>

<p>Boost.Pythonを使うのが便利です。</p>

<p>使いかたは <a href="http://www.boost.org/doc/libs/1_64_0/libs/python/doc/html/index.html">公式ドキュメント</a> や
<a href="https://github.com/TNG/boost-python-examples">TNG/boost-python-examples</a> に詳しく書かれているので、ここでは軽く説明するに留めます。</p>

<p>なお、Boost.Pythonのほかに <a href="http://www.swig.org/">SWIG</a> も使えると思います。</p>

<h3 id="ビルド方法">ビルド方法</h3>

<p>macOSでのPython3を対象とします。</p>

<p>まず、Boost.PythonをHomebrewでインストールするのですが、Python3に対応させるために、<code>--with-python3</code> オプションを付けます。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>$ brew install boost-python --with-python3 --c++11
</pre></div>

<p>GCCを使いたい場合は <code>--cc=gcc-7</code> のようなオプションを追加してください。</p>

<p>ビルドにはCMakeを使うことにします。
次のような<code>CMakeLists.txt</code>を用意してください。
ここでは、<code>mod.cpp</code> をPythonモジュールとしてビルドし、<code>test_mod.py</code> から使います。</p>

<pre><code>cmake_minimum_required(VERSION 3.0.0)

find_package(PythonInterp 3 REQUIRED)
find_package(PythonLibs 3 REQUIRED)
find_package(Boost COMPONENTS python3)

include_directories(${Boost_INCLUDE_DIRS} ${PYTHON_INCLUDE_DIRS})
link_libraries(${Boost_LIBRARIES} ${PYTHON_LIBRARIES})

python_add_module(mod mod.cpp)
file(COPY test_mod.py DESTINATION .)
</code></pre>

<p><code>cmake</code> を実行すると <code>FindBoost.cmake</code> がwarningを吐きますが、とりあえず気にしないでいいようです。</p>

<h3 id="c-の関数を公開する">C++の関数を公開する</h3>

<h4 id="基本">基本</h4>

<p>例えば、次の関数 <code>mult2()</code> をPythonから使えるようにしてみます。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">// fn.cpp</span>

<span style="color: #66d9ef">int</span> <span style="color: #a6e22e">mult2</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">x)</span>
<span style="color: #f8f8f2">{</span>
    <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">x</span> <span style="color: #f92672">*</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
</pre></div>

<p>次の記述を加えるだけで完了です。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;boost/python.hpp&gt;</span>

<span style="color: #66d9ef">using</span> <span style="color: #66d9ef">namespace</span> <span style="color: #f8f8f2">boost</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">python;</span>

<span style="color: #f8f8f2">BOOST_PYTHON_MODULE(fn)</span>
<span style="color: #f8f8f2">{</span>
    <span style="color: #f8f8f2">def(</span><span style="color: #e6db74">&quot;mult2&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">mult2);</span>
<span style="color: #f8f8f2">}</span>
</pre></div>

<p><code>BOOST_PYTHON_MODULE</code> マクロでPythonモジュールを作っています。
ここでは <code>fn</code> モジュールと名付けました。</p>

<p><code>def()</code> 関数に、関数名と関数ポインタを渡すだけです。
関数名はPython側で使いたいものなので好きに設定できます。</p>

<p>Python側では次のように使えます。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f92672">import</span> <span style="color: #f8f8f2">fn</span>

<span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">i</span> <span style="color: #f92672">in</span> <span style="color: #f8f8f2">range(</span><span style="color: #ae81ff">100</span><span style="color: #f8f8f2">):</span>
    <span style="color: #66d9ef">assert</span><span style="color: #f8f8f2">(fn</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">mult2(i)</span> <span style="color: #f92672">==</span> <span style="color: #f8f8f2">i</span> <span style="color: #f92672">*</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span>
</pre></div>

<h4 id="デフォルト引数">デフォルト引数</h4>

<p>デフォルト引数を持つ、次の関数を考えます。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">int</span> <span style="color: #a6e22e">sum</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">x,</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">y</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">{</span>
    <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">x</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">y;</span>
<span style="color: #f8f8f2">}</span>
</pre></div>

<p>これを公開するには、<code>BOOST_PYTHON_FUNCTION_OVERLOADS</code> マクロを使うのが便利です。
このマクロに</p>

<ul>
<li>生成されるクラス名（任意の名前）</li>
<li>関数名</li>
<li>引数の個数の最小・最大値</li>
</ul>

<p>を渡し、<code>def()</code> を下の例のように呼びます。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">BOOST_PYTHON_FUNCTION_OVERLOADS(sum_overloads,</span> <span style="color: #f8f8f2">sum,</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span>

<span style="color: #f8f8f2">BOOST_PYTHON_MODULE(fn)</span>
<span style="color: #f8f8f2">{</span>
    <span style="color: #f8f8f2">def(</span><span style="color: #e6db74">&quot;sum&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">sum,</span> <span style="color: #f8f8f2">sum_overloads());</span>
<span style="color: #f8f8f2">}</span>
</pre></div>

<p>Python側で、デフォルト引数が使えていることが確認できます。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">assert</span><span style="color: #f8f8f2">(fn</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">sum(</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">assert</span><span style="color: #f8f8f2">(fn</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">sum(</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span> <span style="color: #ae81ff">3</span><span style="color: #f8f8f2">)</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">5</span><span style="color: #f8f8f2">)</span>
</pre></div>

<h4 id="オーバーロード">オーバーロード</h4>

<p>関数オーバーロードでも、<code>BOOST_PYTHON_FUNCTION_OVERLOADS</code> マクロを使うのが便利です。
次の関数群 <code>sub()</code> を考えます。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">int</span> <span style="color: #a6e22e">sub</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">x)</span>
<span style="color: #f8f8f2">{</span>
    <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">x;</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">int</span> <span style="color: #a6e22e">sub</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">x,</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">y)</span>
<span style="color: #f8f8f2">{</span>
    <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">x</span> <span style="color: #f92672">-</span> <span style="color: #f8f8f2">y;</span>
<span style="color: #f8f8f2">}</span>
</pre></div>

<p><code>BOOST_PYTHON_FUNCTION_OVERLOADS</code> マクロを、デフォルト引数のときと同じように使います。</p>

<p><code>def()</code> の記述は少し変わっています。
第二引数に、最も多くの引数をとる関数シグネチャを次のように書きます。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">BOOST_PYTHON_FUNCTION_OVERLOADS(sub_overloads,</span> <span style="color: #f8f8f2">sub,</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)</span>

<span style="color: #f8f8f2">BOOST_PYTHON_MODULE(fn)</span>
<span style="color: #f8f8f2">{</span>
    <span style="color: #f8f8f2">def(</span><span style="color: #e6db74">&quot;sub&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">)(</span><span style="color: #66d9ef">int</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">int</span><span style="color: #f8f8f2">))</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">sub_overloads());</span>
<span style="color: #f8f8f2">}</span>
</pre></div>

<h5 id="手動オーバーロード解決">手動オーバーロード解決</h5>

<p><code>sub()</code> の例では、すべての関数オーバーロードのシグネチャが、最も多くの引数をとる関数シグネチャに含まれるという形をとっていました。
これが成り立たないようなオーバーロードは、現時点では自動では扱えないため、手動でラッパーを書く必要があります。</p>

<p>例えば、次の関数を加えたいとします。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">double</span> <span style="color: #a6e22e">sub</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">double</span> <span style="color: #f8f8f2">x)</span>
<span style="color: #f8f8f2">{</span>
    <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">x;</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">double</span> <span style="color: #a6e22e">sub</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">double</span> <span style="color: #f8f8f2">x,</span> <span style="color: #66d9ef">double</span> <span style="color: #f8f8f2">y)</span>
<span style="color: #f8f8f2">{</span>
    <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">x</span> <span style="color: #f92672">-</span> <span style="color: #f8f8f2">y;</span>
<span style="color: #f8f8f2">}</span>
</pre></div>

<p>これを <code>BOOST_PYTHON_FUNCTION_OVERLOADS</code> で扱うことはできないため、次のように別名を付けてやります。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">BOOST_PYTHON_MODULE(fn)</span>
<span style="color: #f8f8f2">{</span>
    <span style="color: #66d9ef">double</span> <span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">sub_double_1)(</span><span style="color: #66d9ef">double</span><span style="color: #f8f8f2">)</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">sub;</span>
    <span style="color: #66d9ef">double</span> <span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">sub_double_2)(</span><span style="color: #66d9ef">double</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">double</span><span style="color: #f8f8f2">)</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">sub;</span>

    <span style="color: #f8f8f2">def(</span><span style="color: #e6db74">&quot;sub&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">sub_double_1);</span>
    <span style="color: #f8f8f2">def(</span><span style="color: #e6db74">&quot;sub&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">sub_double_2);</span>
<span style="color: #f8f8f2">}</span>
</pre></div>

<h4 id="キーワード引数">キーワード引数</h4>

<p>C++の関数を、Python側でキーワード引数が使えるようにして公開することができます。
次の関数を例に取ります。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">double</span> <span style="color: #a6e22e">my_div</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">double</span> <span style="color: #f8f8f2">dividend,</span> <span style="color: #66d9ef">double</span> <span style="color: #f8f8f2">divisor)</span>
<span style="color: #f8f8f2">{</span>
    <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">dividend</span> <span style="color: #f92672">/</span> <span style="color: #f8f8f2">divisor;</span>
<span style="color: #f8f8f2">}</span>
</pre></div>

<p><code>BOOST_PYTHON_MODULE</code> 内に以下のように記述すると、キーワード引数が使えるようになります。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>    <span style="color: #f8f8f2">def(</span><span style="color: #e6db74">&quot;div&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">my_div,</span> <span style="color: #f8f8f2">(arg(</span><span style="color: #e6db74">&quot;dividend&quot;</span><span style="color: #f8f8f2">),</span> <span style="color: #e6db74">&quot;divisor&quot;</span><span style="color: #f8f8f2">));</span>
</pre></div>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">assert</span><span style="color: #f8f8f2">(fn</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">div(</span><span style="color: #ae81ff">3.0</span><span style="color: #f8f8f2">,</span> <span style="color: #ae81ff">2.0</span><span style="color: #f8f8f2">)</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">1.5</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">assert</span><span style="color: #f8f8f2">(fn</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">div(dividend</span><span style="color: #f92672">=</span><span style="color: #ae81ff">3.0</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">divisor</span><span style="color: #f92672">=</span><span style="color: #ae81ff">2.0</span><span style="color: #f8f8f2">)</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">1.5</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">assert</span><span style="color: #f8f8f2">(fn</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">div(divisor</span><span style="color: #f92672">=</span><span style="color: #ae81ff">2.0</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">dividend</span><span style="color: #f92672">=</span><span style="color: #ae81ff">3.0</span><span style="color: #f8f8f2">)</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">1.5</span><span style="color: #f8f8f2">)</span>
</pre></div>

<p>ちなみに、<code>arg(&quot;dividend&quot;) = 0</code> のように書くとデフォルト引数になります。</p>

<h3 id="c-のクラスを公開する">C++のクラスを公開する</h3>

<h4 id="基本-1">基本</h4>

<p>例えば、次の <code>Person</code> クラスをPythonから使えるようにします。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">// cls.cpp</span>

<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;string&gt;</span>

<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">Person</span> <span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">public</span><span style="color: #f92672">:</span>
    <span style="color: #66d9ef">explicit</span> <span style="color: #f8f8f2">Person(std</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">string</span> <span style="color: #f8f8f2">name)</span> <span style="color: #f92672">:</span> <span style="color: #f8f8f2">name(name)</span> <span style="color: #f8f8f2">{}</span>
    <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">std</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">string</span> <span style="color: #f8f8f2">name;</span>

    <span style="color: #f8f8f2">std</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">string</span> <span style="color: #f8f8f2">greet()</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">{</span> <span style="color: #66d9ef">return</span> <span style="color: #e6db74">&quot;My name is &quot;</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">name;</span> <span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">};</span>
</pre></div>

<p>関数のときと同じように、次の記述を加えて完了です。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;boost/python.hpp&gt;</span>
<span style="color: #66d9ef">using</span> <span style="color: #66d9ef">namespace</span> <span style="color: #f8f8f2">boost</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">python;</span>

<span style="color: #f8f8f2">BOOST_PYTHON_MODULE(cls)</span>
<span style="color: #f8f8f2">{</span>
    <span style="color: #f8f8f2">class_</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">Person</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;Person&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">init</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">std</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">string</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">())</span>
        <span style="color: #f8f8f2">.def(</span><span style="color: #e6db74">&quot;greet&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">Person</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">greet);</span>
<span style="color: #f8f8f2">}</span>
</pre></div>

<p><code>class_</code> 関数テンプレートを、公開するクラスを型引数、名前を引数にして呼び出します。
名前とともに <code>init</code> を渡すと、それがコンストラクタになります。</p>

<p><code>def()</code> 関数をチェーン状につなげていくことでメンバ関数を定義できます。
ここでは <code>Person::greet()</code> 関数を <code>greet</code> という名前で公開しています。</p>

<p>すると、Pythonからは次のように使うことができます。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f92672">import</span> <span style="color: #f8f8f2">cls</span>

<span style="color: #f8f8f2">p</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cls</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">Person(</span><span style="color: #e6db74">&quot;pohe&quot;</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">assert</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">greet()</span> <span style="color: #f92672">==</span> <span style="color: #e6db74">&quot;My name is pohe&quot;</span><span style="color: #f8f8f2">)</span>
</pre></div>

<h4 id="コンストラクタ">コンストラクタ</h4>

<p>上述のようにコンストラクタを公開できましたが、オーバーロードするには、<code>def()</code> に <code>init</code> を渡していきます。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>    <span style="color: #f8f8f2">...</span>

    <span style="color: #66d9ef">explicit</span> <span style="color: #f8f8f2">Person(std</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">string</span> <span style="color: #f8f8f2">name,</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">age)</span> <span style="color: #f92672">:</span> <span style="color: #f8f8f2">name(name),</span> <span style="color: #f8f8f2">age(age)</span> <span style="color: #f8f8f2">{}</span>
    <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">age</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
    <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">grow</span><span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span> <span style="color: #f8f8f2">age</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">;</span> <span style="color: #f8f8f2">}</span>

    <span style="color: #f8f8f2">...</span>

<span style="color: #f8f8f2">BOOST_PYTHON_MODULE(cls)</span>
<span style="color: #f8f8f2">{</span>
    <span style="color: #f8f8f2">class_</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">Person</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;Person&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">init</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">std</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">string</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">())</span>
        <span style="color: #f8f8f2">.def(init</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">std</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">string,</span> <span style="color: #66d9ef">int</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">())</span>
        <span style="color: #f8f8f2">.def(</span><span style="color: #e6db74">&quot;greet&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">Person</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">greet);</span>
</pre></div>

<p>なお、コンストラクタを定義しない抽象クラスの場合は、<code>init</code> の代わりに <code>no_init</code> という変数を渡すようです。</p>

<h4 id="メンバ変数">メンバ変数</h4>

<p>先程の例で <code>age</code> メンバ変数（と <code>grow()</code> メンバ関数）を追加しました。
メンバ変数は以下のように <code>def()</code> チェーンにつなげていくことで公開できます。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>        <span style="color: #f8f8f2">...</span>

        <span style="color: #f8f8f2">.def_readwrite(</span><span style="color: #e6db74">&quot;age&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">Person</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">age)</span>
        <span style="color: #f8f8f2">.def(</span><span style="color: #e6db74">&quot;grow&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">Person</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">grow);</span>

        <span style="color: #f8f8f2">...</span>
</pre></div>

<p><code>def_readwrite()</code> を使うと、メンバ変数が読み込み・書き込みともに可能な状態でPythonから扱えるようになります。
<code>def_readonly()</code> を使うと、読み込みのみ可能にできます。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">p</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cls</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">Person(</span><span style="color: #e6db74">&quot;fuga&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">assert</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">age</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">p</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">age</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">10</span>
<span style="color: #66d9ef">assert</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">age</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">10</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">p</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">grow()</span>
<span style="color: #66d9ef">assert</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">age</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">11</span><span style="color: #f8f8f2">)</span>
</pre></div>

<h4 id="プロパティ">プロパティ</h4>

<p>実際のC++では、メンバ変数はprivateにし、getter, setterを定義することが多いでしょう。</p>

<p>上の例に <code>m_height</code>, <code>m_weight</code> メンバ変数を追加し、<code>m_height</code> のgetterとsetter, <code>m_weight</code> のgetterを定義します。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>    <span style="color: #f8f8f2">...</span>

    <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">getHeight()</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">{</span> <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">m_height;</span> <span style="color: #f8f8f2">}</span>
    <span style="color: #66d9ef">void</span> <span style="color: #f8f8f2">setHeight(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">height)</span> <span style="color: #f8f8f2">{</span> <span style="color: #f8f8f2">m_height</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">height;</span> <span style="color: #f8f8f2">}</span>

    <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">getWeight()</span> <span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">{</span> <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">m_weight;</span> <span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">private</span><span style="color: #f92672">:</span>
    <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">m_height</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
    <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">m_weight</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">50</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">};</span>
</pre></div>

<p>Python側に公開するには、<code>add_property()</code> 関数を <code>def()</code> チェーンにつなげていきます。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>        <span style="color: #f8f8f2">...</span>

        <span style="color: #f8f8f2">.add_property(</span><span style="color: #e6db74">&quot;height&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">Person</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">getHeight,</span> <span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">Person</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">setHeight)</span>
        <span style="color: #f8f8f2">.add_property(</span><span style="color: #e6db74">&quot;weight&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">Person</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">getWeight);</span>

        <span style="color: #f8f8f2">...</span>
</pre></div>

<p><code>add_property()</code> 関数に、プロパティ名、getter, setterを渡します。
setterを省略すると読み込み専用になります。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">p</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">height</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">150</span>
<span style="color: #66d9ef">assert</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">height</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">150</span><span style="color: #f8f8f2">)</span>

<span style="color: #66d9ef">assert</span><span style="color: #f8f8f2">(p</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">weight</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">50</span><span style="color: #f8f8f2">)</span>
<span style="color: #75715e"># p.weight = 100 # error</span>
</pre></div>

<h4 id="オペレータ">オペレータ</h4>

<p>C++でのクラスに対する、<code>opeartor+</code> などのオペレータをPythonでも使えるようにします。
次の <code>Person::opeartor+=</code> を例にします。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>    <span style="color: #f8f8f2">Person</span><span style="color: #f92672">&amp;</span> <span style="color: #66d9ef">operator</span><span style="color: #f92672">+=</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">age)</span>
    <span style="color: #f8f8f2">{</span>
        <span style="color: #66d9ef">this</span><span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">age</span> <span style="color: #f92672">+=</span> <span style="color: #f8f8f2">age;</span>
        <span style="color: #66d9ef">return</span> <span style="color: #f92672">*</span><span style="color: #66d9ef">this</span><span style="color: #f8f8f2">;</span>
    <span style="color: #f8f8f2">}</span>
</pre></div>

<p>これを公開するには、<code>def()</code> チェーンに次を追加するだけです。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>    <span style="color: #f8f8f2">...</span>

    <span style="color: #f8f8f2">.def(self</span> <span style="color: #f92672">+=</span> <span style="color: #66d9ef">int</span><span style="color: #f8f8f2">())</span>

    <span style="color: #f8f8f2">...</span>
</pre></div>

<p><code>self</code> が <code>Person</code>, <code>int()</code> が <code>operator+=</code> の引数に対応しています。
他のオペレータでも同様に書けます。</p>

<h4 id="特殊メソッド">特殊メソッド</h4>

<p>Pythonにはいくつか特殊メソッドがあります。
ここでは、よく使う <code>__str__()</code> のみ紹介します。</p>

<p>C++から公開するクラスに <code>___str__()</code> メソッドを定義したいとき、まずC++で <code>operator&lt;&lt;</code> を定義します。
そして、<code>self_ns::str(self_ns::self)</code> を<code>def()</code> チェーンにわたします。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">std</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">ostream</span><span style="color: #f92672">&amp;</span> <span style="color: #66d9ef">operator</span><span style="color: #f92672">&lt;&lt;</span><span style="color: #f8f8f2">(std</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">ostream</span><span style="color: #f92672">&amp;</span> <span style="color: #f8f8f2">os,</span> <span style="color: #f8f8f2">Person</span> <span style="color: #f8f8f2">p)</span>
<span style="color: #f8f8f2">{</span>
    <span style="color: #f8f8f2">os</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #f8f8f2">p.name;</span>
    <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">os;</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #f8f8f2">...</span>

        <span style="color: #f8f8f2">.def(self_ns</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">str(self_ns</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">self))</span>

        <span style="color: #f8f8f2">...</span>
</pre></div>

<p>現時点での公式ドキュメントでは、<code>.def(str(self))</code> のように <code>self_ns</code> 名前空間の指定が書かれていませんが、これがないとコンパイルエラーになります。</p>

<p>これによりPython側で <code>__str__()</code> メソッドが定義され、<code>print()</code> で好きな文字列を表示したりできます。</p>

<h4 id="イテレータ">イテレータ</h4>

<p>C++でのクラスに、Pythonで使えるイテレータを定義することができます。
あまりいい例ではないですが、<code>Person::name</code> を一文字ずつ走査するイテレータを考えます。</p>

<p>Person<code>クラスにイテレータの最初と最後を返すメンバ関数を定義し、</code>def()` チェーンに次のように渡します。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>    <span style="color: #f8f8f2">...</span>

    <span style="color: #66d9ef">auto</span> <span style="color: #f8f8f2">begin()</span> <span style="color: #f8f8f2">{</span> <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">name.begin();</span> <span style="color: #f8f8f2">}</span>
    <span style="color: #66d9ef">auto</span> <span style="color: #f8f8f2">end()</span> <span style="color: #f8f8f2">{</span> <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">name.end();</span> <span style="color: #f8f8f2">}</span>

    <span style="color: #f8f8f2">...</span>

        <span style="color: #f8f8f2">.def(</span><span style="color: #e6db74">&quot;__iter__&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">range(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">Person</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">begin,</span> <span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">Person</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">end));</span>
</pre></div>

<p><code>range()</code> にイテレータの最初と最後を渡しています。
<code>__iter__</code> という名前にすることで、Pythonでのfor文に <code>Person</code> 型が渡せるようになっていますが、
別の名前にすれば、その名前のメソッドがイテレータを返すようになります。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">s</span> <span style="color: #f92672">in</span> <span style="color: #f8f8f2">p:</span>
    <span style="color: #66d9ef">print</span><span style="color: #f8f8f2">(s)</span>
</pre></div>

<h3 id="紹介しなかったもの">紹介しなかったもの</h3>

<ul>
<li>型変換</li>
<li>関数呼び出しポリシー</li>
<li>継承</li>
<li>C++からPythonへの例外の変換</li>
<li>docstring</li>
</ul>

<p>紹介しなかったものや、詳細は <a href="http://www.boost.org/doc/libs/1_64_0/libs/python/doc/html/tutorial/tutorial/exposing.html">公式ドキュメント</a> を参照してください。</p>

<h2 id="call-python-from-c">Call Python from C++</h2>

<p>これもBoost.Pythonを使います。</p>

<p>もともと、PythonのC APIを使ってC/C++からPythonを呼ぶことは（あまり複雑なコードでなければ）難しくなかったため、
Boost.Pythonも今のところ簡単なラッパーを提供するにとどまっています。</p>

<p>PythonのC APIを使う方法で面倒だったのがPythonオブジェクトの参照カウンタの扱いで、
Boost.Pythonがこれを引き受けてくれるのが助かります。</p>

<h3 id="準備">準備</h3>

<p>C++側で <code>boost/python.hpp</code> をインクルードし、<code>Py_Initialize()</code> を呼んで初期化します。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;iostream&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;boost/python.hpp&gt;</span>

<span style="color: #66d9ef">int</span> <span style="color: #a6e22e">main</span><span style="color: #f8f8f2">()</span>
<span style="color: #f8f8f2">{</span>
    <span style="color: #66d9ef">using</span> <span style="color: #66d9ef">namespace</span> <span style="color: #f8f8f2">std;</span>
    <span style="color: #66d9ef">namespace</span> <span style="color: #f8f8f2">bp</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">boost</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">python;</span>

    <span style="color: #66d9ef">try</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #f8f8f2">Py_Initialize();</span>
</pre></div>

<h3 id="モジュールの読み込みと操作">モジュールの読み込みと操作</h3>

<p><code>import()</code> 関数にPythonモジュール名を渡すと、そのモジュールが読み込まれます。
<code>__main__</code> にすれば、白紙状態のメインモジュールになります。
モジュールをはじめ、Boost.PythonでのPythonオブジェクトの型は <code>object</code> になっています。</p>

<p>モジュールの <code>__dict__</code> 属性を辞書として参照することで、そのモジュールの名前空間が得られます。
Boost.Pythonの <code>extract()</code> 関数テンプレートは、PythonオブジェクトからC++側で使うある値を取り出すときに使います。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>        <span style="color: #f8f8f2">bp</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">object</span> <span style="color: #f8f8f2">py_main_module</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">bp</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">import(</span><span style="color: #e6db74">&quot;__main__&quot;</span><span style="color: #f8f8f2">);</span>
        <span style="color: #f8f8f2">bp</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">dict</span> <span style="color: #f8f8f2">py_main_namespace</span>
            <span style="color: #f92672">=</span> <span style="color: #f8f8f2">bp</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">extract</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">bp</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">dict</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">(py_main_module.attr(</span><span style="color: #e6db74">&quot;__dict__&quot;</span><span style="color: #f8f8f2">));</span>
</pre></div>

<p>ちなみに、<code>__main__</code> 以外のモジュールは、相対パスの場合 <code>PYTHONPATH</code> 環境変数からのパスが使われるので、<code>setenv()</code> などでの設定が必要です。</p>

<p>名前空間（実体は辞書）に、C++側で値の追加・変更ができます。
辞書なので名前をキーとして <code>[]</code> でアクセスして代入するだけです。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>        <span style="color: #f8f8f2">py_main_namespace[</span><span style="color: #e6db74">&quot;p&quot;</span><span style="color: #f8f8f2">]</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;po&quot;</span><span style="color: #f8f8f2">;</span>
</pre></div>

<p>PythonオブジェクトからC++での値を取り出すには、先述した <code>extract()</code> 関数テンプレートを使います。
テンプレート引数にC++での型を指定します。</p>

<p>ここで注意なのが、文字列(<code>std::string</code>)を取り出す際、<code>auto</code> で受けると他の型になってしまうので、戻り値の型を明示的に <code>std::string</code> に指定します。
<code>int</code> や <code>double</code> などプリミティブな型は <code>auto</code> で大丈夫なようです。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>        <span style="color: #f8f8f2">std</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">string</span> <span style="color: #f8f8f2">p</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">bp</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">extract</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">std</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">string</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">(py_main_namespace[</span><span style="color: #e6db74">&quot;p&quot;</span><span style="color: #f8f8f2">]);</span>
        <span style="color: #f8f8f2">cout</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #e6db74">&quot;Defined &#39;p = </span><span style="color: #ae81ff">\&quot;</span><span style="color: #e6db74">po</span><span style="color: #ae81ff">\&quot;</span><span style="color: #e6db74">&#39;</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span>
             <span style="color: #f92672">&lt;&lt;</span> <span style="color: #e6db74">&quot;(C++) p = </span><span style="color: #ae81ff">\&quot;</span><span style="color: #e6db74">&quot;</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #f8f8f2">p</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #e6db74">&quot;</span><span style="color: #ae81ff">\&quot;\n</span><span style="color: #e6db74">&quot;</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #f8f8f2">endl;</span>
</pre></div>

<h3 id="pythonの呼び出し">Pythonの呼び出し</h3>

<p>さて、C++からPythonを呼び出してみましょう。
まずは、式を文字列で渡してPythonインタプリタで評価してみます。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>        <span style="color: #f8f8f2">bp</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">object</span> <span style="color: #f8f8f2">py_s2</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">bp</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">eval(</span><span style="color: #e6db74">&quot;p + p&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">py_main_namespace);</span>
        <span style="color: #f8f8f2">p</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">bp</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">extract</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">std</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">string</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">(py_main_namespace[</span><span style="color: #e6db74">&quot;p&quot;</span><span style="color: #f8f8f2">]);</span>
        <span style="color: #f8f8f2">std</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">string</span> <span style="color: #f8f8f2">pp</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">bp</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">extract</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">std</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">string</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">(py_s2);</span>
        <span style="color: #f8f8f2">cout</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #e6db74">&quot;Evaluated &#39;p + p&#39;; resulting in &#39;pp&#39;</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span>
             <span style="color: #f92672">&lt;&lt;</span> <span style="color: #e6db74">&quot;(C++) p = </span><span style="color: #ae81ff">\&quot;</span><span style="color: #e6db74">&quot;</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #f8f8f2">p</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #e6db74">&quot;</span><span style="color: #ae81ff">\&quot;\n</span><span style="color: #e6db74">&quot;</span>
             <span style="color: #f92672">&lt;&lt;</span> <span style="color: #e6db74">&quot;(C++) pp = </span><span style="color: #ae81ff">\&quot;</span><span style="color: #e6db74">&quot;</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #f8f8f2">pp</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #e6db74">&quot;</span><span style="color: #ae81ff">\&quot;\n</span><span style="color: #e6db74">&quot;</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #f8f8f2">endl;</span>
</pre></div>

<p><code>eval()</code> 関数にPythonの式を渡すと、評価結果がPythonオブジェクト（<code>boost::python::object</code>）で返ってきます。
<code>eval()</code> 関数の引数は、</p>

<ul>
<li>第一引数

<ul>
<li>評価する式を文字列で</li>
</ul></li>
<li>第二引数

<ul>
<li>評価する際のローカルな名前空間（辞書）</li>
<li>省略すると空の辞書</li>
</ul></li>
<li>第三引数

<ul>
<li>評価する際のグローバルな名前空間（辞書）</li>
<li>省略すると空の辞書</li>
</ul></li>
</ul>

<p>という仕様です。</p>

<p>次に、文を実行してみます。
これには <code>exec()</code> 関数を使います。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>        <span style="color: #f8f8f2">bp</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">exec(</span><span style="color: #e6db74">R&quot;(</span>
<span style="color: #e6db74">def f():</span>
<span style="color: #e6db74">    global p</span>
<span style="color: #e6db74">    p = p + p</span>
<span style="color: #e6db74">    return p</span>

<span style="color: #e6db74">f()</span>
<span style="color: #e6db74">)&quot;</span><span style="color: #f8f8f2">,</span>
            <span style="color: #f8f8f2">py_main_namespace);</span>
        <span style="color: #f8f8f2">p</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">bp</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">extract</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">std</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">string</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">(py_main_namespace[</span><span style="color: #e6db74">&quot;p&quot;</span><span style="color: #f8f8f2">]);</span>
        <span style="color: #f8f8f2">cout</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #e6db74">&quot;Executed &#39;p = p + p&#39;</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span>
             <span style="color: #f92672">&lt;&lt;</span> <span style="color: #e6db74">&quot;(C++) p = </span><span style="color: #ae81ff">\&quot;</span><span style="color: #e6db74">&quot;</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #f8f8f2">p</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #e6db74">&quot;</span><span style="color: #ae81ff">\&quot;\n</span><span style="color: #e6db74">&quot;</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #f8f8f2">endl;</span>
</pre></div>

<p><code>exec()</code> にPythonの文を渡すと、Pythonインタプリタで実行されます。
第二、第三引数の仕様は <code>eval()</code> と同様です
（<code>exec()</code> もPythonオブジェクトを返すのですが、文の実行結果なので <code>None</code> であり、これを使うことはないと思います）。</p>

<p><code>py_main_namespace[&quot;p&quot;]</code> が更新されていることが確認できます。</p>

<p>最後に、Pythonスクリプトファイルを読み込んで実行します。
今回は、次のファイルを使います。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">ppp</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;po &quot;</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">p</span>
<span style="color: #66d9ef">print</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;(Python) ppp = &quot;</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">ppp)</span>
</pre></div>

<p><code>exec_file()</code> にファイル名（相対パスの場合、実行している場所から）を渡すと、それが読み込まれて実行されます。
第二、第三引数の仕様は <code>exec()</code> などと同様です。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>        <span style="color: #f8f8f2">cout</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #e6db74">&quot;Executing &#39;embedding.py&#39;&quot;</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #f8f8f2">endl;</span>
        <span style="color: #f8f8f2">bp</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">exec_file(</span><span style="color: #e6db74">&quot;embedding.py&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">py_main_namespace);</span>
        <span style="color: #f8f8f2">std</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">string</span> <span style="color: #f8f8f2">ppp</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">bp</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">extract</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">std</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">string</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">(py_main_namespace[</span><span style="color: #e6db74">&quot;ppp&quot;</span><span style="color: #f8f8f2">]);</span>
        <span style="color: #f8f8f2">cout</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #e6db74">&quot;(C++) ppp = </span><span style="color: #ae81ff">\&quot;</span><span style="color: #e6db74">&quot;</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #f8f8f2">ppp</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #e6db74">&quot;</span><span style="color: #ae81ff">\&quot;\n</span><span style="color: #e6db74">&quot;</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #f8f8f2">endl;</span>
</pre></div>

<p>ファイルが存在しない場合、<code>std::invalid_argument</code> 例外が投げられます。</p>

<h3 id="pythonの例外">Pythonの例外</h3>

<p>Pythonインタプリタの実行時に例外が発生すると、Boost.Pythonは <code>error_already_set</code> 例外を投げます。
それ以降の例外処理は実装されていないらしく、<a href="https://docs.python.org/3/c-api/exceptions.html">PythonのC APIリファレンス</a> に従って処理する必要があるようです。
例えば、</p>

<ul>
<li><code>PyErr_ExceptionMatches()</code> 関数で例外の種類を特定</li>
<li><code>PyErr_Print()</code> 関数で例外の内容を表示</li>
</ul>

<p>といったAPIがあります。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>    <span style="color: #f8f8f2">}</span> <span style="color: #66d9ef">catch</span> <span style="color: #f8f8f2">(</span><span style="color: #66d9ef">const</span> <span style="color: #f8f8f2">bp</span><span style="color: #f92672">::</span><span style="color: #f8f8f2">error_already_set</span><span style="color: #f92672">&amp;</span> <span style="color: #f8f8f2">e)</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(PyErr_ExceptionMatches(PyExc_ZeroDivisionError))</span> <span style="color: #f8f8f2">{</span>
            <span style="color: #f8f8f2">cerr</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #e6db74">&quot;(C++) ZeroDivisionError&quot;</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #f8f8f2">endl;</span>
        <span style="color: #f8f8f2">}</span>
        <span style="color: #f8f8f2">PyErr_Print();</span>
        <span style="color: #66d9ef">return</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">;</span>
    <span style="color: #f8f8f2">}</span>

    <span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
</pre></div>

<h2 id="call-c-from-rust">Call C++ from Rust</h2>

<p>一般にC++の関数を他の言語から呼ぶのはかなり困難です。
というのも、ABI</p>

<p><code>servo/rust-bindgen</code> ?</p>

<h2 id="call-rust-from-c">Call Rust from C++</h2>

<p>Rustの関数をC++で呼ぶことは簡単です。</p>

<p>Rustの関数に <code>#[no_mangle]</code>, <code>extern &quot;C&quot;</code> を指定します。
RustとC++の境界部分の型は、<code>libc</code> crateや <code>std::ffi</code> モジュールのものを使います。</p>

<p>例えば、<code>int32_t</code> を二倍する関数は次のように定義できます。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">use</span><span style="color: #f8f8f2"> libc</span>::<span style="color: #f8f8f2">int32_t;</span>

<span style="color: #75715e">#[no_mangle]</span><span style="color: #f8f8f2"></span>
<span style="color: #66d9ef">pub</span><span style="color: #f8f8f2"> </span><span style="color: #66d9ef">extern</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&quot;C&quot;</span><span style="color: #f8f8f2"> </span><span style="color: #66d9ef">fn</span> <span style="color: #a6e22e">mult2</span><span style="color: #f8f8f2">(x</span>: <span style="color: #a6e22e">int32_t</span><span style="color: #f8f8f2">) </span>-&gt; <span style="color: #a6e22e">int32_t</span><span style="color: #f8f8f2"> {</span>
<span style="color: #f8f8f2">    </span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2"> </span><span style="color: #f92672">*</span><span style="color: #f8f8f2"> x</span>
<span style="color: #f8f8f2">}</span>
</pre></div>

<p>C++から呼べるようにビルドするために、<code>Cargo.toml</code> に以下を追加する必要があります。</p>

<pre><code>[lib]
crate-type = [&quot;cdylib&quot;]

[dependencies]
libc = &quot;&gt;= 0.2.24&quot;
</code></pre>

<p><code>libc</code> のバージョンは適当に指定してください。</p>

<p>C++側では、いつも通り関数プロトタイプを書き、呼ぶだけです。</p>

<p>実際のところ、Rustが現時点でサポートしているのは、C++ではなくてC言語です。
そのため、C++側のコードでは、Rustで定義する関数の宣言は、<code>extern &quot;C&quot;</code> で囲ってやる必要があります。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">extern</span> <span style="color: #e6db74">&quot;C&quot;</span> <span style="color: #f8f8f2">{</span>

<span style="color: #66d9ef">int32_t</span> <span style="color: #f8f8f2">mult2(</span><span style="color: #66d9ef">int32_t</span> <span style="color: #f8f8f2">x);</span>

<span style="color: #f8f8f2">}</span>
</pre></div>

<p>もう少し複雑な関数を書いてみます。
文字列から部分文字列を検索し、その位置を返す関数です。
部分文字列がなかった場合、-1を返します。</p>

<p><code>libc</code>, <code>std::ffi</code> の型を使い、RustとC++間での型を変換します。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">use</span><span style="color: #f8f8f2"> std</span>::<span style="color: #f8f8f2">ffi</span>::<span style="color: #f8f8f2">CStr;</span>
<span style="color: #66d9ef">use</span><span style="color: #f8f8f2"> libc</span>::<span style="color: #f8f8f2">{c_char, ssize_t};</span>

<span style="color: #75715e">#[no_mangle]</span><span style="color: #f8f8f2"></span>
<span style="color: #66d9ef">pub</span><span style="color: #f8f8f2"> </span><span style="color: #66d9ef">extern</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&quot;C&quot;</span><span style="color: #f8f8f2"> </span><span style="color: #66d9ef">fn</span> <span style="color: #a6e22e">find_substr</span><span style="color: #f8f8f2">(haystack</span>: <span style="color: #f92672">*</span><span style="color: #66d9ef">const</span><span style="color: #f8f8f2"> c_char, needle</span>: <span style="color: #f92672">*</span><span style="color: #66d9ef">const</span><span style="color: #f8f8f2"> c_char) </span>-&gt; <span style="color: #a6e22e">ssize_t</span><span style="color: #f8f8f2"> {</span>
<span style="color: #f8f8f2">    </span><span style="color: #66d9ef">let</span><span style="color: #f8f8f2"> haystack </span><span style="color: #f92672">=</span><span style="color: #f8f8f2"> </span><span style="color: #66d9ef">unsafe</span><span style="color: #f8f8f2"> { CStr</span>::<span style="color: #f8f8f2">from_ptr(haystack).to_str() };</span>
<span style="color: #f8f8f2">    </span><span style="color: #66d9ef">let</span><span style="color: #f8f8f2"> needle </span><span style="color: #f92672">=</span><span style="color: #f8f8f2"> </span><span style="color: #66d9ef">unsafe</span><span style="color: #f8f8f2"> { CStr</span>::<span style="color: #f8f8f2">from_ptr(needle).to_str() };</span>
<span style="color: #f8f8f2">    </span><span style="color: #66d9ef">match</span><span style="color: #f8f8f2"> (haystack, needle) {</span>
<span style="color: #f8f8f2">        (Ok(h), Ok(n)) </span><span style="color: #f92672">=&gt;</span><span style="color: #f8f8f2"> {</span>
<span style="color: #f8f8f2">            </span><span style="color: #66d9ef">match</span><span style="color: #f8f8f2"> h.find(n) {</span>
<span style="color: #f8f8f2">                Some(p) </span><span style="color: #f92672">=&gt;</span><span style="color: #f8f8f2"> p </span><span style="color: #66d9ef">as</span><span style="color: #f8f8f2"> ssize_t,</span>
<span style="color: #f8f8f2">                None </span><span style="color: #f92672">=&gt;</span><span style="color: #f8f8f2"> </span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span>
<span style="color: #f8f8f2">            }</span>
<span style="color: #f8f8f2">        }</span>
<span style="color: #f8f8f2">        _ </span><span style="color: #f92672">=&gt;</span><span style="color: #f8f8f2"> </span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span>
<span style="color: #f8f8f2">    }</span>
<span style="color: #f8f8f2">}</span>
</pre></div>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;stdint.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;stdio.h&gt;</span>

<span style="color: #66d9ef">extern</span> <span style="color: #e6db74">&quot;C&quot;</span> <span style="color: #f8f8f2">{</span>
<span style="color: #66d9ef">ssize_t</span> <span style="color: #f8f8f2">find_substr(</span><span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span> <span style="color: #f8f8f2">haystack,</span> <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span> <span style="color: #f8f8f2">needle);</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">main(</span><span style="color: #66d9ef">void</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">{</span>
    <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span> <span style="color: #f8f8f2">haystack</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;po-he&quot;</span><span style="color: #f8f8f2">;</span>
    <span style="color: #66d9ef">const</span> <span style="color: #66d9ef">char</span><span style="color: #f92672">*</span> <span style="color: #f8f8f2">needle</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;-&quot;</span><span style="color: #f8f8f2">;</span>
    <span style="color: #66d9ef">auto</span> <span style="color: #f8f8f2">p</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">find_substr(haystack,</span> <span style="color: #f8f8f2">needle);</span>
    <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(p</span> <span style="color: #f92672">&gt;</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;%ld, </span><span style="color: #ae81ff">\&quot;</span><span style="color: #e6db74">%s</span><span style="color: #ae81ff">\&quot;\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">p,</span> <span style="color: #f8f8f2">haystack</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">p);</span>
    <span style="color: #f8f8f2">}</span> <span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;not found</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">);</span>
    <span style="color: #f8f8f2">}</span>

    <span style="color: #66d9ef">return</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span>
<span style="color: #f8f8f2">}</span>
</pre></div>

<p>最後に、構造体を扱ってみます。
次のようなC++コード（<code>extern &quot;C&quot;</code> で囲んでいるので、実質C言語）を考え、<code>divmod_impl()</code> 関数をRustで定義します。
構造体を戻り値にすることはできないので、ポインタで渡して書き換えるという方法を取り、C++側ではそれをラップした関数を作っています。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">extern</span> <span style="color: #e6db74">&quot;C&quot;</span> <span style="color: #f8f8f2">{</span>

<span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">DivMod</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #66d9ef">int32_t</span> <span style="color: #f8f8f2">div;</span>
    <span style="color: #66d9ef">int32_t</span> <span style="color: #f8f8f2">mod;</span>
<span style="color: #f8f8f2">};</span>

<span style="color: #66d9ef">void</span> <span style="color: #a6e22e">divmod_impl</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int32_t</span> <span style="color: #f8f8f2">x,</span> <span style="color: #66d9ef">int32_t</span> <span style="color: #f8f8f2">y,</span> <span style="color: #f8f8f2">DivMod</span><span style="color: #f92672">*</span> <span style="color: #f8f8f2">dm);</span>

<span style="color: #f8f8f2">DivMod</span> <span style="color: #a6e22e">divmod</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int32_t</span> <span style="color: #f8f8f2">x,</span> <span style="color: #66d9ef">int32_t</span> <span style="color: #f8f8f2">y)</span>
<span style="color: #f8f8f2">{</span>
    <span style="color: #f8f8f2">DivMod</span> <span style="color: #f8f8f2">dm;</span>
    <span style="color: #f8f8f2">divmod_impl(x,</span> <span style="color: #f8f8f2">y,</span> <span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">dm);</span>
    <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">dm;</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #f8f8f2">}</span>  <span style="color: #75715e">// extern &quot;C&quot;</span>
</pre></div>

<p>Rust側のコードは以下のようになります。</p>

<p>構造体は <code>repr(C)</code> 指定によってC言語と同じような内部表現を取らせる必要があります。
また、生ポインタのderef操作は <code>unsafe</code> ブロックで囲みます。</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">#[repr(C)]</span><span style="color: #f8f8f2"></span>
<span style="color: #66d9ef">pub</span><span style="color: #f8f8f2"> </span><span style="color: #66d9ef">struct</span> <span style="color: #a6e22e">DivMod</span><span style="color: #f8f8f2"> {</span>
<span style="color: #f8f8f2">    </span><span style="color: #66d9ef">pub</span><span style="color: #f8f8f2"> div</span>: <span style="color: #a6e22e">int32_t</span><span style="color: #f8f8f2">,</span>
<span style="color: #f8f8f2">    </span><span style="color: #66d9ef">pub</span><span style="color: #f8f8f2"> mod_</span>: <span style="color: #a6e22e">int32_t</span><span style="color: #f8f8f2">,</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #75715e">#[no_mangle]</span><span style="color: #f8f8f2"></span>
<span style="color: #66d9ef">pub</span><span style="color: #f8f8f2"> </span><span style="color: #66d9ef">extern</span><span style="color: #f8f8f2"> </span><span style="color: #e6db74">&quot;C&quot;</span><span style="color: #f8f8f2"> </span><span style="color: #66d9ef">fn</span> <span style="color: #a6e22e">divmod_impl</span><span style="color: #f8f8f2">(x</span>: <span style="color: #a6e22e">int32_t</span><span style="color: #f8f8f2">, y</span>: <span style="color: #a6e22e">int32_t</span><span style="color: #f8f8f2">, divmod</span>: <span style="color: #f92672">*</span><span style="color: #66d9ef">mut</span><span style="color: #f8f8f2"> DivMod) {</span>
<span style="color: #f8f8f2">    </span><span style="color: #66d9ef">let</span><span style="color: #f8f8f2"> (div, mod_) </span><span style="color: #f92672">=</span><span style="color: #f8f8f2"> </span><span style="color: #66d9ef">match</span><span style="color: #f8f8f2"> y {</span>
<span style="color: #f8f8f2">        </span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2"> </span><span style="color: #f92672">=&gt;</span><span style="color: #f8f8f2"> (</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">, </span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">),</span>
<span style="color: #f8f8f2">        _ </span><span style="color: #f92672">=&gt;</span><span style="color: #f8f8f2"> (x </span><span style="color: #f92672">/</span><span style="color: #f8f8f2"> y, x </span><span style="color: #f92672">%</span><span style="color: #f8f8f2"> y),</span>
<span style="color: #f8f8f2">    };</span>

<span style="color: #f8f8f2">    </span><span style="color: #66d9ef">unsafe</span><span style="color: #f8f8f2"> {</span>
<span style="color: #f8f8f2">        (</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">divmod).div </span><span style="color: #f92672">=</span><span style="color: #f8f8f2"> div;</span>
<span style="color: #f8f8f2">        (</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">divmod).mod_ </span><span style="color: #f92672">=</span><span style="color: #f8f8f2"> mod_;</span>
<span style="color: #f8f8f2">    }</span>
<span style="color: #f8f8f2">}</span>
</pre></div>

<h2 id="call-c-from-javascript">Call C++ from Javascript</h2>

<p>emscripten</p>

<h2 id="call-javascript-from-c">Call Javascript from C++</h2>

<p>emscripten</p>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="/post/introducing_xv6/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="/post/introducing_xv6/">Introducing xv6</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="/post/convert_markdown_to_pdf/">Convert Markdown to PDF</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="/post/convert_markdown_to_pdf/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  

</div>


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] }
  });
</script>
<script
    type="text/javascript"
    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" />
</script>

